# URGENT: Login Redirect Bug Fix

## BLOCKER SEVERITY - Production Blocking Issue

### Root Cause
**Race condition in useEffect dependency array causing infinite loop prevention**

**Exact Location:** `/src/app/login/page.tsx` lines 26-39

### The Problem

```typescript
// BROKEN CODE:
useEffect(() => {
  if (user && !isRedirecting) {  // ← Condition becomes false after first run
    setIsRedirecting(true)       // ← This triggers useEffect to re-run
    router.push(redirect)
    router.refresh()             // ← May interrupt the push()
  }
}, [user, searchParams, router, isRedirecting])  // ← isRedirecting causes re-run
```

### Failure Sequence
1. signIn() succeeds → user state updates
2. useEffect runs with `isRedirecting = false` → condition passes
3. `setIsRedirecting(true)` executes
4. `router.push()` and `router.refresh()` execute
5. **useEffect runs AGAIN** because `isRedirecting` changed
6. Condition `if (user && !isRedirecting)` is now FALSE
7. Redirect code doesn't execute on second run
8. User stuck at "Redirecting..." forever

### The Fix (OPTION 1 - RECOMMENDED)

**File:** `/src/app/login/page.tsx`

Replace lines 26-39 with:

```typescript
useEffect(() => {
  if (user) {
    const redirect = searchParams.get('redirect') || '/'
    console.log('[Login] User authenticated, redirecting to:', redirect)
    setIsRedirecting(true)

    // Use replace instead of push (cleaner navigation, no back button issue)
    router.replace(redirect)
    // Remove router.refresh() - not needed and may interrupt navigation
  }
}, [user, searchParams, router])
// CRITICAL: Remove isRedirecting from dependency array
```

### Alternative Fix (OPTION 2 - Using Ref)

```typescript
// Add at top of LoginForm component:
const hasRedirected = useRef(false)

// Replace useEffect:
useEffect(() => {
  if (user && !hasRedirected.current) {
    hasRedirected.current = true
    const redirect = searchParams.get('redirect') || '/'
    console.log('[Login] User authenticated, redirecting to:', redirect)
    setIsRedirecting(true)
    router.replace(redirect)
  }
}, [user, searchParams, router])
```

### Why This Happens

**The useEffect dependency array triggers re-execution when ANY dependency changes:**
- First run: `isRedirecting` is `false` → executes redirect logic
- `setIsRedirecting(true)` changes the state
- Second run: `isRedirecting` is `true` → condition fails, no redirect
- Result: User sees "Redirecting..." but nothing happens

**The `router.refresh()` call compounds the problem:**
- May interrupt `router.push()` before navigation completes
- Not necessary when using `router.replace()`

### Testing Verification

After applying fix, verify:
1. Login with test credentials
2. "Redirecting..." appears for < 1 second
3. User lands on dashboard (/) within 2 seconds
4. No console errors
5. No infinite loops or multiple redirect attempts

### Expected Console Log Flow (Working)
```
[Login] Attempting sign in with: test@example.com
[AuthProvider] Attempting signInWithPassword...
[AuthProvider] Sign in successful: test@example.com
[AuthProvider] Session created: true
[AuthProvider] State updated, allowing React to handle redirect...
[Login] Sign in successful, waiting for state update...
[Login] User authenticated, redirecting to: /
```

### Impact Assessment
- **Priority:** BLOCKER
- **Severity:** CRITICAL
- **Impact:** 100% of users cannot log in
- **Time to Fix:** 2 minutes
- **Risk:** None - simplifies logic, removes race condition

### Files to Modify
1. `/Users/dre/lenkersdorfer-crm/src/app/login/page.tsx` (lines 26-39)

### Implementation Steps
1. Open `/src/app/login/page.tsx`
2. Locate useEffect on lines 26-39
3. Apply Option 1 fix (recommended)
4. Test login flow
5. Verify redirect completes in < 3 seconds
6. Deploy immediately

---
**Generated by QA-GUARDIAN Testing System**
**Issue Severity: BLOCKER**
**Fix Complexity: TRIVIAL**
**Estimated Fix Time: 2 minutes**
